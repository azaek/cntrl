# Builds and releases Cntrl Bridge for Windows and macOS
# Channels: stable (v*), beta (v*-beta*)
# Generates latest-stable.json or latest-beta.json for updater
name: Release Bridge

on:
  push:
    tags:
      - "bridge-v*" # Stable: v1.0.0, v1.0.1
      - "bridge-v*-beta*" # Beta: v1.0.0-beta.1

env:
  CARGO_TERM_COLOR: always

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release_id: ${{ steps.create-release.outputs.id }}
      channel: ${{ steps.check-channel.outputs.channel }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine channel and version
        id: check-channel
        run: |
          # Strip "bridge-" prefix for display: bridge-v1.0.0 -> v1.0.0
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#bridge-}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          if [[ "${{ github.ref_name }}" == *"beta"* ]]; then
            echo "channel=beta" >> $GITHUB_OUTPUT
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "channel=stable" >> $GITHUB_OUTPUT
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        id: create-release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          prerelease: ${{ steps.check-channel.outputs.prerelease }}
          generate_release_notes: true
          name: Cntrl Bridge ${{ steps.check-channel.outputs.version }}

  build-tauri:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS Apple Silicon
          - platform: macos-latest
            target: aarch64-apple-darwin
            args: "--target aarch64-apple-darwin"
          # macOS Intel
          - platform: macos-latest
            target: x86_64-apple-darwin
            args: "--target x86_64-apple-darwin"
          # Windows x64
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            args: ""

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Cache Rust artifacts
        uses: swatinem/rust-cache@v2
        with:
          workspaces: apps/bridge/src-tauri -> target

      - name: Sync version from tag
        run: |
          # Extract version from tag: bridge-v0.1.0-beta.1 -> 0.1.0-beta.1
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#bridge-v}"
          echo "Setting version to $VERSION"

          # Update tauri.conf.json
          cd apps/bridge/src-tauri
          node -e "
            const fs = require('fs');
            const conf = JSON.parse(fs.readFileSync('tauri.conf.json', 'utf8'));
            conf.version = '$VERSION';
            fs.writeFileSync('tauri.conf.json', JSON.stringify(conf, null, 2) + '\n');
            console.log('tauri.conf.json version:', conf.version);
          "

          # Update Cargo.toml (supports semver pre-release identifiers)
          node -e "
            const fs = require('fs');
            let cargo = fs.readFileSync('Cargo.toml', 'utf8');
            cargo = cargo.replace(/^version = \"[^\"]*\"/m, 'version = \"$VERSION\"');
            fs.writeFileSync('Cargo.toml', cargo);
            console.log('Cargo.toml version:', '$VERSION');
          "
        shell: bash

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          projectPath: apps/bridge
          releaseId: ${{ needs.create-release.outputs.release_id }}
          tagName: ${{ github.ref_name }}
          args: ${{ matrix.args }}

  publish-release:
    runs-on: ubuntu-latest
    needs: [create-release, build-tauri]
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download release assets
        uses: robinraju/release-downloader@v1
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          fileName: "latest.json"
          out-file-path: ./release-assets
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create channel-specific update manifest
        run: |
          CHANNEL="${{ needs.create-release.outputs.channel }}"

          # Copy latest.json to channel-specific filename
          cp ./release-assets/latest.json ./release-assets/latest-${CHANNEL}.json

          echo "Created latest-${CHANNEL}.json"
          cat ./release-assets/latest-${CHANNEL}.json

      - name: Upload channel manifest to release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: ./release-assets/latest-${{ needs.create-release.outputs.channel }}.json

      - name: Update latest channel manifest in dedicated branch
        run: |
          CHANNEL="${{ needs.create-release.outputs.channel }}"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create or switch to updates branch
          git fetch origin updates || true
          git checkout updates || git checkout -b updates

          # Create updates directory if it doesn't exist
          mkdir -p updates

          # Copy the channel manifest
          cp ./release-assets/latest-${CHANNEL}.json ./updates/latest-${CHANNEL}.json

          # Commit and push
          git add updates/
          git commit -m "Update latest-${CHANNEL}.json to ${{ github.ref_name }}" || echo "No changes to commit"
          git push origin updates

      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          tag_name: ${{ github.ref_name }}
